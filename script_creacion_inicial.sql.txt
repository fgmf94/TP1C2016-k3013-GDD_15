/*CREO NUEVO ESQUEMA */
CREATE SCHEMA [GDD_15] AUTHORIZATION [gd];
GO
/*CREO LAS  19 TABLAS DEL DER.
LOS CAMPOS QUE EMPIEZAN CON N_ID SON IDS
N_ NUMEROS
C_ CODIGOS
D_ DESCRIPCIONES 
D_DESCRED DESCRIPCION 
D_DESCRIP DESCRIPCION CORTA
*/

/*CREO LA TABLA DE USUARIOS */
CREATE TABLE GDD_15.USUARIOS (
	N_ID_USUARIO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_USUARIO_NOMBRE VARCHAR(250) UNIQUE,
	C_PASSWORD VARCHAR(250),
	N_CANT_INTENTOS TINYINT DEFAULT 0,
	N_PUBLICACION_GRATIS VARCHAR(2) DEFAULT 'NO',
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE DIRECCIONES */
CREATE TABLE GDD_15.DIRECCIONES (
	N_ID_DIRECCION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_CALLE VARCHAR(100),
	N_NUMERO BIGINT,
	C_PISO VARCHAR(50),
	C_DEPTO VARCHAR(50),
	C_POSTAL VARCHAR(50)
);
GO
/*CREO LA TABLA DE ROLES */
CREATE TABLE GDD_15.ROLES (
	N_ID_ROL BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ROL VARCHAR(100) UNIQUE,
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE ROLES POR USUARIO */
CREATE TABLE GDD_15.ROLES_USUARIOS (
	N_ID_USUARIO BIGINT NOT NULL,
	N_ID_ROL BIGINT NOT NULL,
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES */
CREATE TABLE GDD_15.FUNCIONALIDADES (
	N_ID_FUNCIONALIDAD BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRED VARCHAR(100) UNIQUE,
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES POR ROLES */
CREATE TABLE GDD_15.FUNCIONALIDADES_ROLES (
	N_ID_ROL BIGINT NOT NULL,
	N_ID_FUNCIONALIDAD BIGINT NOT NULL,
);
GO
/*CREO LA TABLA DE RUBROS */
CREATE TABLE GDD_15.RUBROS (
	N_ID_RUBRO BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRIP VARCHAR(50) UNIQUE,
	D_DESCRED VARCHAR(250) UNIQUE
);
GO
/*CREO LA TABLA DE EMPRESAS */
CREATE TABLE GDD_15.EMPRESAS (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_RUBRO BIGINT,
	N_ID_DIRECCION BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT VARCHAR(50),
	D_NOMBRE_CONTACTO VARCHAR(100),
	N_TELEFONO BIGINT,
	C_CORREO VARCHAR(50),
	F_CREACION DATETIME
);
GO
/*CREO LA TABLA DE CLIENTES */
CREATE TABLE GDD_15.CLIENTES (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_DIRECCION BIGINT,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100) NOT NULL,
	D_APELLIDOS VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	F_NACIMIENTO DATETIME,
	N_TELEFONO BIGINT,
	C_CORREO VARCHAR(50),
	N_COMPRA_HABILITADA TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE PUBLICACIONES */
CREATE TABLE GDD_15.PUBLICACIONES (
	N_ID_PUBLICACION BIGINT IDENTITY(71079,1) PRIMARY KEY,
	C_VISIBILIDAD BIGINT,
	N_ID_USUARIO BIGINT,
	N_ID_RUBRO BIGINT,
	N_ID_ESTADO BIGINT,
	N_ID_TIPO BIGINT,
	D_DESCRED VARCHAR(100),
	N_STOCK INT,
	F_INICIO DATETIME,
	F_VENCIMIENTO DATETIME,
	N_PRECIO FLOAT(24),
	C_PERMITE_ENVIO VARCHAR(2) DEFAULT 'NO'
);
GO
/*CREO LA TABLA DE ESTADOS */
CREATE TABLE GDD_15.ESTADOS (
	N_ID_ESTADO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ESTADO VARCHAR(50),
);
GO
/*CREO LA TABLA DE TIPOS */
CREATE TABLE GDD_15.TIPOS (
	N_ID_TIPO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_TIPO VARCHAR(50),
);
GO
/*CREO LA TABLA DE FACTURAS */
CREATE TABLE GDD_15.FACTURAS (
	N_ID_FACTURA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT NOT NULL,
	C_TIPO_PAGO VARCHAR(50) DEFAULT 'Efectivo',
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE LOS ITEMS DE LAS FACTURAS */
CREATE TABLE GDD_15.FACTURAS_ITEMS (
	N_ID_ITEM BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_FACTURA BIGINT NOT NULL,
	C_VISIBILIDAD BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_COMPRA BIGINT,
	N_MONTO FLOAT(24),
);
GO
/*CREO LA TABLA DE VISIBILIDADES */
CREATE TABLE GDD_15.VISIBILIDADES (
	C_VISIBILIDAD BIGINT IDENTITY(10002,1) PRIMARY KEY ,
	D_DESCRIP VARCHAR(50) UNIQUE,
	N_COMISION_PRECIO FLOAT(24),
	N_COMISION_PORCENTAJE FLOAT(24),
	N_COMISION_ENVIO FLOAT(24),
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE OFERTAS */
CREATE TABLE GDD_15.OFERTAS (
	N_ID_OFERTA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_MONTO FLOAT(24),
	C_GANADOR VARCHAR(2) DEFAULT 'NO',
	C_ENVIO VARCHAR(2) DEFAULT 'NO'
);
GO
/*CREO LA TABLA DE COMPRAS */
CREATE TABLE GDD_15.COMPRAS (
	N_ID_COMPRA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_CANTIDAD INT,
	C_ENVIO VARCHAR(2) DEFAULT 'NO'
);
GO
/*CREO LA TABLA DE CALIFICACIONES */
CREATE TABLE GDD_15.CALIFICACIONES (
	N_ID_CALIFICACION BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_COMPRA BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_CLIENTE BIGINT,
	C_CALIFICACION SMALLINT,
	D_DESCRIP VARCHAR(250)
);
GO

/* CREO  LAS PRIMARY KEY COMPUESTAS  */
alter table GDD_15.ROLES_USUARIOS add constraint PK_ROL_POR_USUARIO
	primary key clustered (N_ID_ROL,N_ID_USUARIO);
GO
alter table GDD_15.FUNCIONALIDADES_ROLES add constraint PK_FUNC_POR_ROL
	primary key clustered (N_ID_ROL,N_ID_FUNCIONALIDAD);
GO

/*CREO LAS FOREIGN KEY*/ 

alter table GDD_15.FACTURAS add constraint FK_FACTURA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM
	foreign key (N_ID_FACTURA) references GDD_15.FACTURAS (N_ID_FACTURA);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_VISIBILIDAD
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS (N_ID_OFERTA);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS (N_ID_COMPRA);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRAS_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
-- FK publicaciones--
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_VISIB
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS (N_ID_RUBRO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS (N_ID_USUARIO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_ESTADO
	foreign key (N_ID_ESTADO) references GDD_15.ESTADOS (N_ID_ESTADO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_TIPO
	foreign key (N_ID_TIPO) references GDD_15.TIPOS (N_ID_TIPO);
GO

alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS(N_ID_COMPRA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS(N_ID_OFERTA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS(N_ID_RUBRO);
GO

alter table GDD_15.EMPRESAS add constraint FK_EMPRESA_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLI_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLIENTE_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO


--CREO TABLA TEMPORAL QUE ME AYUDA AL MOMENTO DE LA MIGRACION DE CLIENTES Y EMPRESAS--
CREATE TABLE GDD_15.#tmp_usuarios
( 
	n_id_usuario bigint identity(1,1),
	N_ID_DIRECCION BIGINT,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100) ,
	D_APELLIDOS VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	F_NACIMIENTO DATETIME,
	C_CORREO VARCHAR(50),
	N_TELEFONO TINYINT,
	N_ID_RUBRO BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT VARCHAR(50),
	D_NOMBRE_CONTACTO VARCHAR(100),
	F_CREACION DATETIME

);
GO

--CREO TRIGGER EN CLIENTES QUE ME INSERTA EL CLIENTE EN LA TABLA USUARIOS--
create TRIGGER  alta_USUARIO ON gdd_15.CLIENTES 
	 after insert AS
begin
SET IDENTITY_INSERT gdd_15.USUARIOS  ON
  
	insert into  GDD_15.USUARIOS
	(n_id_usuario,c_usuario_nombre , C_PASSWORD)
	select N_ID_USUARIO, N_DOCUMENTO,(SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256',N_DOCUMENTO)),3,250))
	from inserted
	
	SET IDENTITY_INSERT gdd_15.USUARIOS  off
end;
GO
--CREO TRIGGER EN EMPRESAS QUE ME INSERTA LA EMPRESA EN LA TABLA USUARIOS--
create TRIGGER  alta_USU_EMP  ON gdd_15.EMPRESAS 
	 after insert AS
begin
SET IDENTITY_INSERT gdd_15.USUARIOS  ON

	insert into  GDD_15.USUARIOS
	(n_id_usuario,c_usuario_nombre , C_PASSWORD )
	select N_ID_USUARIO, N_CUIT, (SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256',N_CUIT)),3,250))
	from inserted
	
	SET IDENTITY_INSERT gdd_15.USUARIOS  off
end;
GO

CREATE PROCEDURE GDD_15.MIGRO_DIRECCIONES AS 
BEGIN
	/* INSERTO DIRECCIONES DE LOS CLIENTES */
	INSERT INTO GDD_15.DIRECCIONES 
	(
		C_CALLE,
		N_NUMERO,
		C_DEPTO,
		C_PISO,
		C_POSTAL
	)
	select DISTINCT Cli_Dom_Calle,
					Cli_Nro_Calle,
					Cli_Depto,
					Cli_Piso,
					Cli_Cod_Postal
	FROM gd_esquema.Maestra
	WHERE Cli_Dni IS NOT NULL;

	/* INSERTO DIRECCIONES DE LOS EMPRESAS */
	INSERT INTO GDD_15.DIRECCIONES 
	(
		C_CALLE,
		N_NUMERO,
		C_DEPTO,
		C_PISO,
		C_POSTAL
	)
	SELECT DISTINCT Publ_Empresa_Dom_Calle,
					Publ_Empresa_Nro_Calle,
					Publ_Empresa_Piso,
					Publ_Empresa_Depto,
					Publ_Empresa_Cod_Postal
	FROM gd_esquema.Maestra 
	WHERE Publ_Empresa_Cuit IS NOT NULL;
END;
GO
-- PRC QUE MIGRA CLIENTES Y EMPRESAS ---
CREATE PROCEDURE GDD_15.MIGRO_USUARIOS AS
BEGIN
	/*  INSERTO CLIENTES  en la tmp_usuarios*/
	INSERT INTO #tmp_usuarios
	(	
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION, 
		C_CORREO
	)
	SELECT DISTINCT m.Cli_Dni,
					'DNI',					
					m.Cli_Apeliido,
					m.Cli_Nombre,
					CONVERT(CHAR(10),Cli_Fecha_Nac,103)fecha_nac,
					d.N_ID_DIRECCION, 
					M.Cli_Mail
	FROM gd_esquema.Maestra m, gdd_15.DIRECCIONES d
	WHERE m.Cli_Dni IS NOT NULL
	and d.n_numero=m.Cli_Nro_Calle
	and d.c_piso=convert(varchar(50),m.Cli_Piso)
	and d.C_DEPTO=convert(varchar(50),m.Cli_Depto)
	and d.C_CALLE=m.Cli_Dom_Calle;
	
	/*INSERTO EMPRESAS  en la tmp_usuarios*/
	INSERT INTO #tmp_usuarios
	(
		
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
	)
	SELECT DISTINCT m.Publ_Empresa_Cuit,
					CONVERT(CHAR(10),Publ_Empresa_Fecha_Creacion,103)fecha_CREAC,
					m.Publ_Empresa_Mail,
					m.Publ_Empresa_Razon_Social,
					d.N_ID_DIRECCION		
	FROM gd_esquema.Maestra m, gdd_15.DIRECCIONES d 
	WHERE Publ_Empresa_Cuit IS NOT NULL
	and d.n_numero=m.Publ_Empresa_Nro_Calle
	and d.C_CALLE=m.Publ_Empresa_Dom_Calle;


	alter TABLE GDD_15.CLIENTES 
	NOCHECK CONSTRAINT FK_CLIENTE_USUARIO;
/*INSERTO CLIENTES */
	INSERT INTO GDD_15.CLIENTES
	(	N_ID_USUARIO,
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION,
		C_CORREO
	)
select	N_ID_USUARIO,
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION,
		C_CORREO 
		from #tmp_usuarios
where N_DOCUMENTO is not null;

	alter TABLE GDD_15.EMPRESAS 
	NOCHECK CONSTRAINT FK_EMPRESA_USUARIO;

/*INSERTO EMPRESAS*/
	INSERT INTO GDD_15.EMPRESAS
	(
		N_ID_USUARIO,
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
	)
SELECT N_ID_USUARIO,
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
		FROM #tmp_usuarios
		WHERE N_CUIT IS NOT NULL
		;
END;
GO
 -- PRC QUE MIGRA LOS RUBROS--
CREATE PROCEDURE GDD_15.MIGRO_RUBROS AS
BEGIN
	INSERT INTO GDD_15.RUBROS
	(D_DESCRED, D_DESCRIP)
	SELECT  DISTINCT Publicacion_Rubro_Descripcion,
	CASE 
	WHEN Publicacion_Rubro_Descripcion = 'Audio para el Hogar' THEN 'AUDI1'
	WHEN Publicacion_Rubro_Descripcion = 'Audio Portátil y Radios' THEN 'AUDI2'
	WHEN Publicacion_Rubro_Descripcion = 'Audio / Video Profesional y DJ' THEN 'AUDI3'
	ELSE SUBSTRING(UPPER(Publicacion_Rubro_Descripcion),1,5)
	END AS Publicacion_Rubro_Descripcion
	FROM gd_esquema.Maestra m 
	WHERE Publicacion_Rubro_Descripcion IS NOT NULL
	ORDER BY 1; 
END;
GO
CREATE PROCEDURE GDD_15.CARGO_ESTADO_TIPO_VISI AS
BEGIN

/* Cargo las visibilidades */
INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Platino', 180, 0.10, 20

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Oro', 140, 0.15, 30

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Plata', 100, 0.20, 40

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Bronze', 60, 0.30, 50

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Gratis', 0, 0, 0

--Inserto los tipos de Publicacion--
INSERT INTO GDD_15.TIPOS(C_TIPO) VALUES ('Subasta');
INSERT INTO GDD_15.TIPOS(C_TIPO) VALUES ('Compra Inmediata');

--Inserto los estados de una Publicacion--
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Borrador');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Activa');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Pausada');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Finalizada');
END;
GO

--MIGRO PUBLICACIONES--
CREATE PROCEDURE GDD_15.MIGRO_PUBLICACIONES AS
BEGIN

	SET IDENTITY_INSERT GDD_15.PUBLICACIONES ON

	INSERT INTO GDD_15.PUBLICACIONES
	(
		N_ID_PUBLICACION,
		C_VISIBILIDAD,
		N_ID_USUARIO,
		N_ID_RUBRO,
		N_ID_ESTADO,
		n_id_tipo,
		D_DESCRED,
		N_STOCK,
		F_INICIO,
		F_VENCIMIENTO,
		N_PRECIO
	)
	select distinct
			M.Publicacion_Cod,
			M.Publicacion_Visibilidad_Cod ,
			case when m.publ_cli_dni is not null
			 then(select c.n_id_usuario 
					from GDD_15.CLIENTES c
					where c.N_DOCUMENTO = m.publ_cli_dni)
			else
				(select e.n_id_usuario
				from GDD_15.EMPRESAS e 
				where e.N_CUIT = m.Publ_Empresa_Cuit)
			end N_ID_USUARIO,
			(SELECT  R.N_ID_RUBRO FROM GDD_15. RUBROS R
			WHERE M.Publicacion_Rubro_Descripcion = R.D_DESCRED  )N_ID_RUBRO,
			4 N_ID_ESTADO,
			(SELECT T.N_ID_TIPO FROM GDD_15.TIPOS T
			WHERE M.PUBLICACION_TIPO = T.C_TIPO) N_ID_TIPO,
			Publicacion_Descripcion,
			Publicacion_Stock,
			Publicacion_Fecha,
			Publicacion_Fecha_Venc,
			Publicacion_Precio
	FROM gd_esquema.Maestra m
	WHERE Publicacion_Cod IS NOT NULL

	SET IDENTITY_INSERT GDD_15.PUBLICACIONES OFF

END;
GO

/*CREO LA TABLA TEMPORAL DE COMPRAS */
CREATE TABLE GDD_15.#TMP_COMPRAS (
	N_ID_COMPRA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_CANTIDAD INT,
	C_ENVIO VARCHAR(2) DEFAULT 'NO'
);
GO

CREATE PROCEDURE GDD_15.MIGRO_COMPRAS_TEMP AS
BEGIN

	INSERT INTO GDD_15.#TMP_COMPRAS
	(
		N_ID_PUBLICACION,
		N_ID_CLIENTE,
		N_CANTIDAD,
		F_ALTA
	)
	SELECT
	 M.Publicacion_Cod,
	 (SELECT C.N_ID_USUARIO 
		 FROM GDD_15.CLIENTES C
		 WHERE C.N_DOCUMENTO = M.Cli_Dni) N_ID_CLIENTE,
	 Compra_Cantidad,
	 Compra_Fecha
	  FROM gd_esquema.Maestra m
	  WHERE COMPRA_CANTIDAD IS NOT NULL
	  ORDER BY Publicacion_Cod ASC, N_ID_CLIENTE asc, Compra_Fecha ASC, Compra_Cantidad ASC, Calificacion_Cant_Estrellas ASC;

	  DELETE FROM GDD_15.#TMP_COMPRAS WHERE (N_ID_COMPRA  % 2) = 1

END
GO

--MIGRO COMPRAS --
CREATE PROCEDURE GDD_15.MIGRO_COMPRAS AS
BEGIN

	
	alter TABLE GDD_15.COMPRAS
	NOCHECK CONSTRAINT FK_COMPRA_PUBL;
	--INSERTO COMPRAS --
	INSERT INTO GDD_15.COMPRAS
	(
		N_ID_PUBLICACION,
		N_ID_CLIENTE,
		N_CANTIDAD,
		F_ALTA
	)

	SELECT N_ID_PUBLICACION, N_ID_CLIENTE, N_CANTIDAD, F_ALTA FROM GDD_15.#TMP_COMPRAS

END;
GO
-- PRC QUE SIRVE PARA ACUALIZAR EL GANADOR DE LA OFERTA , QUE ES QUIEN TIENE EL MONTO MAXIMO --
CREATE PROCEDURE GDD_15.ACTUALIZO_OFERTAS AS
BEGIN
DECLARE @v_n_id_publicacion BIGINT,@v_monto REAL
-- Declaro un cursor para el manejo de las ofertas migradas--
DECLARE ofertas CURSOR FOR
	SELECT  n_id_publicacion, max(n_monto) monto
	from GDD_15.ofertas
	group by N_ID_PUBLICACION
	order by N_ID_PUBLICACION;

OPEN ofertas

	-- Inserto lo que obtiene el cursor en las variables
	FETCH NEXT FROM ofertas
	INTO @v_n_id_publicacion,@v_monto
	
	  WHILE @@FETCH_STATUS = 0
		BEGIN 
			-- Actualizo AL GANADOR DE LA OFERTA --
			UPDATE GDD_15.ofertas
			set c_ganador = 'SI'
			WHERE N_ID_PUBLICACION =@v_n_id_publicacion
			AND N_MONTO = @v_monto
					
			-- Inserto lo que obtiene el cursor en las variables
			FETCH NEXT FROM ofertas
			INTO @v_n_id_publicacion,@v_monto

END
CLOSE ofertas
DEALLOCATE ofertas
END;
GO
--MIGRO OFERTAS--
CREATE PROCEDURE GDD_15.MIGRO_OFERTAS AS 
BEGIN
alter TABLE GDD_15.OFERTAS
	NOCHECK CONSTRAINT FK_OFERTA_PUBL;
	  --INSERTO OFERTAS---
	  INSERT INTO GDD_15.OFERTAS
	(
		N_ID_PUBLICACION,
		N_ID_CLIENTE,
		N_MONTO,
		F_ALTA
	)
		SELECT DISTINCT M.Publicacion_Cod,
				(SELECT C.N_ID_USUARIO 
					FROM GDD_15.CLIENTES C
					WHERE C.N_DOCUMENTO = M.Cli_Dni) N_ID_CLIENTE,
				Oferta_Monto,
				Oferta_Fecha
	  FROM gd_esquema.Maestra m
	  WHERE Oferta_Monto IS NOT NULL
	  ORDER BY Publicacion_Cod ASC , N_ID_CLIENTE ASC ;
	  
	  EXEC  GDD_15.ACTUALIZO_OFERTAS;
END;


GO
--MIGRO FACTURAS--
CREATE PROCEDURE GDD_15.MIGRO_FACTURAS AS
BEGIN
	alter TABLE GDD_15.FACTURAS
	NOCHECK CONSTRAINT FK_FACTURA_PUBL;
	--INSERTO FACTURAS --
	SET IDENTITY_INSERT gdd_15.FACTURAS  oN
	INSERT INTO GDD_15.FACTURAS
	(
		N_ID_FACTURA,
		N_ID_PUBLICACION,
		F_ALTA,
		C_TIPO_PAGO
	 )
	select	DISTINCT factura_nro,
			Publicacion_Cod,
			Factura_Fecha,
			--Factura_Total,
			Forma_Pago_Desc
	from gd_esquema.Maestra
	where Factura_Nro is not null 
	ORDER BY 1,2
	---58726 facturas
SET IDENTITY_INSERT gdd_15.FACTURAS  oFF

END;
GO

/*CREO TMP DE CALIFICACIONES */
CREATE TABLE GDD_15.#TMP_CALIFICACIONES (
	N_ID_PUBLICACION BIGINT,
	N_ID_CALIFICACION BIGINT,
	N_ID_COMPRA BIGINT,
	N_ID_OFERTA	BIGINT,
	N_ID_CLIENTE BIGINT,
	C_CALIFICACION SMALLINT,
	D_DESCRIP VARCHAR(250)
);
GO
--MIGRO CALIFICACIONES--
CREATE PROCEDURE GDD_15.MIGRO_CALIFICACIONES AS
BEGIN

	INSERT INTO #tmp_calificaciones
	(
		N_ID_PUBLICACION,
		N_ID_COMPRA,
		N_ID_OFERTA,
		N_ID_CLIENTE,
		N_ID_CALIFICACION,
		D_DESCRIP,
		C_CALIFICACION 	
	)

	SELECT PUBLICACION_COD,
	C.N_ID_COMPRA,
	NULL N_ID_OFERTA,
	(select c.n_id_usuario 
	from GDD_15.CLIENTES c
	where c.N_DOCUMENTO = cli_dni)
	N_ID_USUARIO,
	Calificacion_Codigo,
	Calificacion_Descripcion,
	FLOOR((Calificacion_Cant_Estrellas + 1) / 2) Calificacion
	FROM GDD_15.COMPRAS C JOIN gd_esquema.Maestra m  ON (M.Publicacion_Cod = C.N_ID_PUBLICACION)
	WHERE M.Calificacion_Codigo IS NOT NULL
	AND M.Compra_Cantidad = C.N_CANTIDAD
	AND M.Compra_Fecha = C.F_ALTA
	AND (select c.n_id_usuario  from GDD_15.CLIENTES c where c.N_DOCUMENTO = cli_dni) = C.N_ID_CLIENTE
	AND PUBLICACION_COD IN (SELECT N_ID_PUBLICACION FROM GDD_15.COMPRAS)
	ORDER BY Publicacion_Cod ASC,  N_ID_COMPRA ASC;

	WITH CTE AS(
    SELECT N_ID_COMPRA,
    RN = ROW_NUMBER() OVER(PARTITION BY N_ID_COMPRA ORDER BY N_ID_COMPRA)
    FROM #tmp_calificaciones
    )
	DELETE FROM CTE WHERE RN > 1

	INSERT INTO #tmp_calificaciones
	(
		N_ID_PUBLICACION,
		N_ID_COMPRA,
		N_ID_OFERTA,
		N_ID_CLIENTE,
		N_ID_CALIFICACION,
		D_DESCRIP,
		C_CALIFICACION 	
	)

	SELECT DISTINCT PUBLICACION_COD,
	NULL N_ID_COMPRA,
	F.N_ID_OFERTA,
	(select c.n_id_usuario 
	from GDD_15.CLIENTES c
	where c.N_DOCUMENTO = cli_dni)
	N_ID_USUARIO,
	Calificacion_Codigo,
	Calificacion_Descripcion,
	FLOOR((Calificacion_Cant_Estrellas + 1) / 2) Calificacion
	FROM GDD_15.OFERTAS F JOIN gd_esquema.Maestra m  ON (M.Publicacion_Cod = F.N_ID_PUBLICACION)
	WHERE M.Calificacion_Codigo IS NOT NULL
	AND M.Compra_Fecha = F.F_ALTA
	AND (select c.n_id_usuario  from GDD_15.CLIENTES c where c.N_DOCUMENTO = cli_dni) = F.N_ID_CLIENTE
	AND PUBLICACION_COD IN (SELECT N_ID_PUBLICACION FROM GDD_15.OFERTAS) 
	AND F.C_GANADOR = 'SI'

	INSERT INTO GDD_15.CALIFICACIONES SELECT N_ID_COMPRA, N_ID_OFERTA, N_ID_CLIENTE, C_CALIFICACION, D_DESCRIP FROM #tmp_calificaciones

END;
GO

/* Migro items de las vibibilidades */
CREATE PROCEDURE GDD_15.MIGRO_ITEMS_VISIBILIDADES
AS
BEGIN
	INSERT INTO GDD_15.FACTURAS_ITEMS (
	N_ID_FACTURA,
	C_VISIBILIDAD,
	N_MONTO)
	SELECT N_ID_FACTURA, P.C_VISIBILIDAD, N_COMISION_PRECIO FROM GDD_15.PUBLICACIONES P
	JOIN GDD_15.VISIBILIDADES V ON (P.C_VISIBILIDAD = V.C_VISIBILIDAD)
	JOIN GDD_15.FACTURAS F ON (F.N_ID_PUBLICACION = P.N_ID_PUBLICACION)
END;
GO

/* Migro items de las ofertas ganadas */

CREATE PROCEDURE GDD_15.MIGRO_ITEMS_OFERTAS
AS
BEGIN
	INSERT INTO GDD_15.FACTURAS_ITEMS (
	N_ID_FACTURA,
	N_ID_OFERTA,
	N_MONTO)
	SELECT N_ID_FACTURA, N_ID_OFERTA, N_COMISION_PORCENTAJE*N_MONTO FROM GDD_15.OFERTAS O
	JOIN GDD_15.PUBLICACIONES P ON (P.N_ID_PUBLICACION = O.N_ID_PUBLICACION)
	JOIN GDD_15.VISIBILIDADES V ON (P.C_VISIBILIDAD = V.C_VISIBILIDAD)
	JOIN GDD_15.FACTURAS F ON (F.N_ID_PUBLICACION = P.N_ID_PUBLICACION)
	WHERE C_GANADOR = 'SI'
END;
GO

/* Migro items de las compras */
CREATE PROCEDURE GDD_15.MIGRO_ITEMS_COMPRAS
AS
BEGIN
	INSERT INTO GDD_15.FACTURAS_ITEMS (
	N_ID_FACTURA,
	N_ID_COMPRA,
	N_MONTO)
	SELECT N_ID_FACTURA, N_ID_COMPRA, N_COMISION_PORCENTAJE*N_CANTIDAD*N_PRECIO FROM GDD_15.COMPRAS C
	JOIN GDD_15.PUBLICACIONES P ON (P.N_ID_PUBLICACION = C.N_ID_PUBLICACION)
	JOIN GDD_15.VISIBILIDADES V ON (P.C_VISIBILIDAD = V.C_VISIBILIDAD)
	JOIN GDD_15.FACTURAS F ON (F.N_ID_PUBLICACION = P.N_ID_PUBLICACION)
END;
GO

/* Hago un procedure para eliminar compras de más */
CREATE PROCEDURE GDD_15.ELIMINO_COMPRAS_TMP
AS
BEGIN
	DELETE FROM GDD_15.#TMP_COMPRAS WHERE N_ID_PUBLICACION IN (SELECT N_ID_PUBLICACION FROM GDD_15.OFERTAS)
END;
GO

/*Inserto las funcionalidades*/

INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rol');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Usuarios');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rubro');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de visibilidad de publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Generar Publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Comprar/Ofertar');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Historial');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Calificar al Vendedor');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Consulta de facturas');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Listado Estadístico');
GO

/*Creo el rol Administrativo*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Administrativo');
GO

/*Se agregan funcionalidades al rol Administrativo*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Administrativo' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Rol', 'ABM de Usuarios', 'ABM de Rubro', 'ABM de visibilidad de publicación', 'Listado Estadístico');
GO

/*Creo el rol Cliente*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Cliente');
GO

/*Se agregan funcionalidades al rol Cliente*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Cliente' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'Generar Publicación', 'Comprar/Ofertar', 'Historial', 'Calificar al Vendedor', 'Consulta de facturas', 'Listado Estadístico');
GO

/*Creo el rol Empresa*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Empresa');
GO

/*Se agregan funcionalidades al rol Empresa*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Empresa' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'Generar Publicación', 'Consulta de facturas', 'Listado Estadístico');
GO

--INICIO MIGRACION --

EXEC GDD_15.MIGRO_DIRECCIONES;
EXEC GDD_15.MIGRO_USUARIOS;
EXEC GDD_15.MIGRO_RUBROS;
EXEC GDD_15.CARGO_ESTADO_TIPO_VISI;
EXEC GDD_15.MIGRO_PUBLICACIONES;
EXEC GDD_15.MIGRO_FACTURAS;
EXEC GDD_15.MIGRO_ITEMS_VISIBILIDADES;
EXEC GDD_15.MIGRO_OFERTAS;
EXEC GDD_15.MIGRO_ITEMS_OFERTAS
EXEC GDD_15.MIGRO_COMPRAS_TEMP;
EXEC GDD_15.ELIMINO_COMPRAS_TMP;
EXEC GDD_15.MIGRO_COMPRAS;
EXEC GDD_15.MIGRO_ITEMS_COMPRAS;
EXEC GDD_15.MIGRO_CALIFICACIONES;
GO
--- FIN DE LA MIGRACIÓN--

-- ELIMINO LAS TMP QUE UTILIZAMOS PARA LA MIGRACIÓN--
DROP TABLE dbo.#tmp_usuarios;
GO
DROP TABLE dbo.#tmp_CALIFICACIONES;
GO
DROP TABLE GDD_15.#TMP_COMPRAS;
GO
DROP TRIGGER GDD_15.alta_USUARIO;
GO
DROP TRIGGER GDD_15.alta_USU_EMP;
GO


/* Se inserta el usuario admin, password w23e */

INSERT INTO GDD_15.USUARIOS(C_USUARIO_NOMBRE,C_PASSWORD)
VALUES ('admin',(SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256','w23e')),3,250) ))
GO

/* Se le asigna el rol administrativo al usuario admin */

INSERT INTO GDD_15.ROLES_USUARIOS(N_ID_USUARIO, N_ID_ROL)
SELECT tablaUsuarios.N_ID_USUARIO, tablaRoles.N_ID_ROL FROM GDD_15.USUARIOS tablaUsuarios, GDD_15.ROLES tablaRoles
WHERE tablaUsuarios.C_USUARIO_NOMBRE = 'admin' AND tablaRoles.C_ROL = 'Administrativo'
GO

/* Se asignan los roles de empresa y cliente a los usuarios creados */

INSERT INTO GDD_15.ROLES_USUARIOS(N_ID_USUARIO, N_ID_ROL)
SELECT C.N_ID_USUARIO, R.N_ID_ROL FROM GDD_15.CLIENTES C, GDD_15.ROLES R
WHERE R.C_ROL = 'Cliente'
GO

INSERT INTO GDD_15.ROLES_USUARIOS(N_ID_USUARIO, N_ID_ROL)
SELECT E.N_ID_USUARIO, R.N_ID_ROL FROM GDD_15.EMPRESAS E, GDD_15.ROLES R
WHERE R.C_ROL = 'Empresa'
GO

/* PROCEDURES Y TRIGGERS DEL DOMINIO */

CREATE TRIGGER GDD_15.BAJA_ROL ON GDD_15.ROLES 
AFTER UPDATE AS
BEGIN
	-- Declaracion de variables para el cursor
	DECLARE	@N_ID_ROL BIGINT,
			@C_ROL varchar(100),
			@N_HABILITADO TINYINT
	-- Declaración del cursor
	DECLARE cROLES CURSOR FOR
	SELECT N_ID_ROL, C_ROL, N_HABILITADO
	FROM INSERTED
	-- Apertura del cursor
	OPEN cROLES
	-- Lectura de la primera fila del cursor
	FETCH cROLES INTO @N_ID_ROL, @C_ROL, @N_HABILITADO
	WHILE (@@FETCH_STATUS = 0 )
	BEGIN
		-- Si el rol queda deshabilitado, actualiza la tabla de roles_usuarios
		IF @N_HABILITADO = 0
		BEGIN
			UPDATE ROLES_USUARIOS
			SET N_HABILITADO = 0
			WHERE N_ID_ROL = @N_ID_ROL
		END
		
		-- Lectura de la siguiente fila del cursor
		FETCH cROLES INTO @N_ID_ROL, @C_ROL, @N_HABILITADO
	END
	-- Cierre del cursor
	CLOSE cROLES
	-- Liberar los recursos
	DEALLOCATE cROLES
END
GO

CREATE PROCEDURE GDD_15.AGREGARPUBLICACION @usuarioID BIGINT, @rubroID BIGINT, @visiID BIGINT, @estadoID BIGINT, @tipoID BIGINT, @descrip VARCHAR(100), @stock INT, @fecha_inicio DATETIME, @fecha_ven DATETIME, @precio FLOAT(24), @permite_envio VARCHAR(2), @beneficioGratis VARCHAR(2)
AS
BEGIN
	DECLARE @visiDesc VARCHAR(50), @precioVisi FLOAT(24), @estado VARCHAR(50)
	SELECT @visiDesc = D_DESCRIP, @precioVisi = N_COMISION_PRECIO FROM GDD_15.VISIBILIDADES WHERE C_VISIBILIDAD = @visiID
	SELECT @estado = C_ESTADO FROM GDD_15.ESTADOS WHERE N_ID_ESTADO = @estadoID
	IF (@estado = 'Borrador')
	BEGIN
		INSERT INTO GDD_15.PUBLICACIONES(N_ID_USUARIO, N_ID_RUBRO, C_VISIBILIDAD, N_ID_ESTADO, N_ID_TIPO, D_DESCRED, N_STOCK, F_INICIO, F_VENCIMIENTO, N_PRECIO, C_PERMITE_ENVIO) VALUES (@usuarioID , @rubroID, + @visiID, @estadoID, @tipoID, @descrip, @stock, @fecha_inicio, @fecha_ven, @precio, @permite_envio)
	END
	ELSE IF  (@estado = 'Activa')
	BEGIN
		DECLARE @publiID BIGINT, @facturaID BIGINT
		INSERT INTO GDD_15.PUBLICACIONES(N_ID_USUARIO, N_ID_RUBRO, C_VISIBILIDAD, N_ID_ESTADO, N_ID_TIPO, D_DESCRED, N_STOCK, F_INICIO, F_VENCIMIENTO, N_PRECIO, C_PERMITE_ENVIO) VALUES (@usuarioID , @rubroID, + @visiID, @estadoID, @tipoID, @descrip, @stock, @fecha_inicio, @fecha_ven, @precio, @permite_envio)
		SELECT @publiID = SCOPE_IDENTITY()
		INSERT INTO GDD_15.FACTURAS(N_ID_PUBLICACION, F_ALTA) VALUES (@publiID,@fecha_inicio)
		IF (@beneficioGratis = 'NO')
		BEGIN
			SELECT @facturaID = SCOPE_IDENTITY()
			INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, C_VISIBILIDAD, N_MONTO) VALUES (@facturaID, @visiID, @precioVisi)
		END
		ELSE
		BEGIN 
			SELECT @facturaID = SCOPE_IDENTITY()
			INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, C_VISIBILIDAD, N_MONTO) VALUES (@facturaID, @visiID, 0)
			UPDATE GDD_15.USUARIOS SET N_PUBLICACION_GRATIS = 'NO' WHERE N_ID_USUARIO = @usuarioID
		END
	END
END;
GO

CREATE PROCEDURE GDD_15.BORRADOR_A_ACTIVA @usuarioID BIGINT, @rubroID BIGINT, @visiID BIGINT, @estadoID BIGINT, @tipoID BIGINT, @descrip VARCHAR(100), @stock INT, @fecha_inicio DATETIME, @fecha_ven DATETIME, @precio FLOAT(24), @permite_envio VARCHAR(2), @idPubli BIGINT, @beneficioGratis VARCHAR(2)
AS
BEGIN
	DECLARE @visiDesc VARCHAR(50), @precioVisi FLOAT(24), @estado VARCHAR(50)
	SELECT @visiDesc = D_DESCRIP, @precioVisi = N_COMISION_PRECIO FROM GDD_15.VISIBILIDADES WHERE C_VISIBILIDAD = @visiID
	SELECT @estado = C_ESTADO FROM GDD_15.ESTADOS WHERE N_ID_ESTADO = @estadoID
	IF (@estado = 'Borrador')
	BEGIN
		UPDATE GDD_15.PUBLICACIONES SET N_ID_USUARIO = @usuarioID, N_ID_RUBRO = @rubroID, C_VISIBILIDAD = @visiID, N_ID_ESTADO = @estadoID, N_ID_TIPO = @tipoID, D_DESCRED = @descrip, N_STOCK = @stock, F_INICIO = @fecha_inicio, F_VENCIMIENTO = @fecha_ven, N_PRECIO = @precio, C_PERMITE_ENVIO = @permite_envio WHERE N_ID_PUBLICACION = @idPubli
	END
	ELSE IF  (@estado = 'Activa')
	BEGIN
		DECLARE @facturaID BIGINT
		UPDATE GDD_15.PUBLICACIONES SET N_ID_USUARIO = @usuarioID, N_ID_RUBRO = @rubroID, C_VISIBILIDAD = @visiID, N_ID_ESTADO = @estadoID, N_ID_TIPO = @tipoID, D_DESCRED = @descrip, N_STOCK = @stock, F_INICIO = @fecha_inicio, F_VENCIMIENTO = @fecha_ven, N_PRECIO = @precio, C_PERMITE_ENVIO = @permite_envio WHERE N_ID_PUBLICACION = @idPubli
		INSERT INTO GDD_15.FACTURAS(N_ID_PUBLICACION, F_ALTA) VALUES (@idPubli,@fecha_inicio)
		IF (@beneficioGratis = 'NO')
		BEGIN
			SELECT @facturaID = SCOPE_IDENTITY()
			INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, C_VISIBILIDAD, N_MONTO) VALUES (@facturaID, @visiID, @precioVisi)
		END
		ELSE
		BEGIN 
			SELECT @facturaID = SCOPE_IDENTITY()
			INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, C_VISIBILIDAD, N_MONTO) VALUES (@facturaID, @visiID, 0)
			UPDATE GDD_15.USUARIOS SET N_PUBLICACION_GRATIS = 'NO' WHERE N_ID_USUARIO = @usuarioID
		END
	END
END;
GO

CREATE PROCEDURE GDD_15.COMPRAR @publiID BIGINT, @usuarioID BIGINT, @fecha_alta DATETIME, @cantidad INT, @envio VARCHAR(2)
AS
BEGIN
	DECLARE @visiID BIGINT, @porcentajeVisi FLOAT(24), @envioVisi FLOAT(24), @facturaID BIGINT, @precioPubli FLOAT(24), @compraID BIGINT, @stock INT
	SELECT @visiID = C_VISIBILIDAD, @precioPubli = N_PRECIO, @stock = N_STOCK FROM GDD_15.PUBLICACIONES WHERE N_ID_PUBLICACION = @publiID
	SELECT @porcentajeVisi = N_COMISION_PORCENTAJE, @envioVisi = N_COMISION_ENVIO FROM GDD_15.VISIBILIDADES WHERE C_VISIBILIDAD = @visiID
	INSERT INTO GDD_15.COMPRAS(N_ID_PUBLICACION,N_ID_CLIENTE,F_ALTA,N_CANTIDAD,C_ENVIO) VALUES (@publiID, @usuarioID, @fecha_alta, @cantidad, @envio)
	SELECT @compraID = SCOPE_IDENTITY()
	INSERT INTO GDD_15.FACTURAS(N_ID_PUBLICACION, F_ALTA) VALUES (@publiID,@fecha_alta)
	SELECT @facturaID = SCOPE_IDENTITY()
	INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, N_ID_COMPRA, N_MONTO) VALUES (@facturaID, @compraID, @precioPubli * @cantidad * @porcentajeVisi)
	UPDATE GDD_15.PUBLICACIONES SET N_STOCK = (@stock - @cantidad) WHERE N_ID_PUBLICACION = @publiID
	IF  (@envio = 'SI')
	BEGIN
		INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, C_VISIBILIDAD, N_ID_COMPRA, N_MONTO) VALUES (@facturaID, @visiID, @compraID, @envioVisi)
	END
END;
GO

CREATE TRIGGER GDD_15.FINALIZAR_POR_STOCK ON GDD_15.PUBLICACIONES
AFTER UPDATE AS
BEGIN
	DECLARE	@idPubli BIGINT, @fecha_Ven DATETIME, @stock INT
	DECLARE cPUBLIS CURSOR FOR
	SELECT N_ID_PUBLICACION, F_VENCIMIENTO, N_STOCK
	FROM INSERTED
	OPEN cPUBLIS
	FETCH cPUBLIS INTO @idPubli, @fecha_Ven, @stock

	WHILE (@@FETCH_STATUS = 0 )
	BEGIN
		IF @stock = 0
		BEGIN
			UPDATE PUBLICACIONES SET N_ID_ESTADO = 4 WHERE N_ID_PUBLICACION = @idPubli
		END
		FETCH cPUBLIS INTO @idPubli, @fecha_Ven, @stock
	END

	CLOSE cPUBLIS
	DEALLOCATE cPUBLIS
END
GO

CREATE PROCEDURE GDD_15.FINALIZAR_PUBLI @idPubli BIGINT
AS
BEGIN
	DECLARE @visiID BIGINT, @porcentajeVisi FLOAT(24), @envioVisi FLOAT(24), @facturaID BIGINT, @monto FLOAT(24), @ofertaID BIGINT, @stock INT, @envio VARCHAR(2), @idTipo BIGINT, @fechaVen DATETIME
	SELECT @idTipo = N_ID_TIPO FROM GDD_15.PUBLICACIONES WHERE N_ID_PUBLICACION = @idPubli
	IF (@idTipo = 2)
	BEGIN
		UPDATE PUBLICACIONES SET N_ID_ESTADO = 4 WHERE N_ID_PUBLICACION = @idPubli
	END
	ELSE
	BEGIN
		IF((SELECT COUNT(*) FROM GDD_15.OFERTAS WHERE N_ID_PUBLICACION = @idPubli) = 0)
			BEGIN
				UPDATE PUBLICACIONES SET N_ID_ESTADO = 4 WHERE N_ID_PUBLICACION = @idPubli
			END
		ELSE
		BEGIN
			SELECT @visiID = C_VISIBILIDAD, @fechaVen = F_VENCIMIENTO, @stock = N_STOCK FROM GDD_15.PUBLICACIONES WHERE N_ID_PUBLICACION = @idPubli
			SELECT @porcentajeVisi = N_COMISION_PORCENTAJE, @envioVisi = N_COMISION_ENVIO FROM GDD_15.VISIBILIDADES WHERE C_VISIBILIDAD = @visiID
			SELECT @ofertaID = N_ID_OFERTA, @monto = MAX(N_MONTO), @envio = C_ENVIO FROM GDD_15.OFERTAS WHERE N_ID_PUBLICACION = @idPubli GROUP BY N_ID_OFERTA, C_ENVIO
			INSERT INTO GDD_15.FACTURAS(N_ID_PUBLICACION, F_ALTA) VALUES (@idPubli, @fechaVen)
			SELECT @facturaID = SCOPE_IDENTITY()
			INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, N_ID_COMPRA, N_MONTO) VALUES (@facturaID, @ofertaID, @monto * @porcentajeVisi)
			UPDATE GDD_15.PUBLICACIONES SET N_STOCK = (@stock - 1) WHERE N_ID_PUBLICACION = @idPubli
			UPDATE GDD_15.OFERTAS SET C_GANADOR = 'SI' WHERE N_ID_OFERTA = @ofertaID
			IF  (@envio = 'SI')
			BEGIN
				INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, C_VISIBILIDAD, N_ID_COMPRA, N_MONTO) VALUES (@facturaID, @visiID, @ofertaID, @envioVisi)
			END	
		END
	END
END;
GO

CREATE PROCEDURE GDD_15.FINALIZAR_PUBLIS @fecha_inicio DATETIME
AS
BEGIN
	DECLARE	@idPubli BIGINT
	DECLARE cPUBLIS2 CURSOR FOR
	SELECT N_ID_PUBLICACION FROM GDD_15.PUBLICACIONES WHERE N_ID_ESTADO = 2 OR N_ID_ESTADO = 3
	OPEN cPUBLIS2
	FETCH cPUBLIS2 INTO @idPubli
	DECLARE @fechaVen DATETIME

	WHILE (@@FETCH_STATUS = 0 )
	BEGIN
		SELECT @fechaVen = F_VENCIMIENTO FROM GDD_15.PUBLICACIONES WHERE N_ID_PUBLICACION = @idPubli
		IF(YEAR(@fecha_inicio) > YEAR(@fechaVen))
		BEGIN
			EXEC GDD_15.FINALIZAR_PUBLI @idPubli
		END
		ELSE IF (YEAR(@fecha_inicio) = YEAR(@fechaVen) AND MONTH(@fecha_inicio) > MONTH(@fechaVen))
		BEGIN
			EXEC GDD_15.FINALIZAR_PUBLI @idPubli
		END
		ELSE IF (YEAR(@fecha_inicio) = YEAR(@fechaVen) AND MONTH(@fecha_inicio) = MONTH(@fechaVen) AND DAY(@fecha_inicio) > DAY(@fechaVen))
		BEGIN
			EXEC GDD_15.FINALIZAR_PUBLI @idPubli
		END
		FETCH cPUBLIS2 INTO @idPubli
	END

	CLOSE cPUBLIS2
	DEALLOCATE cPUBLIS2
END;
GO
--LISTADO ESTADISTICO --

--FUNCIONES CREADAS PARA LOS LISTADOS --
--DEV EL MES DE INICIO DEL TRIMESTRE--
CREATE FUNCTION GDD_15.DEV_F_INICIO_TRI(@P_TRI INT )
RETURNS INT
AS
BEGIN

	RETURN(SELECT CASE WHEN @P_TRI = 1 THEN  01 
	WHEN @P_TRI = 2 THEN   04 
	WHEN @P_TRI =3  THEN  07
	WHEN @P_TRI = 4 THEN  10
	END);

END;
GO
--DEV EL MES HASTA EL QUE INCLUYE EL TRIMESTRE--
CREATE FUNCTION GDD_15.DEV_F_HASTA_TRI(@P_TRI INT )
RETURNS INT
AS
BEGIN

	RETURN(SELECT CASE WHEN @P_TRI = 1 THEN  3 
	WHEN @P_TRI = 2 THEN   6
	WHEN @P_TRI =3  THEN  9
	WHEN @P_TRI = 4 THEN  12
	END);

END;
GO
--DEV EL NOMBRE DEL USUARIO --
CREATE FUNCTION GDD_15.DEV_USUARIO(@P_N_ID_USUARIO INT)
RETURNS VARCHAR(300) AS
BEGIN
DECLARE @NOMBRE VARCHAR(300)
	IF EXISTS(SELECT N_ID_USUARIO
	FROM GDD_15.EMPRESAS
	WHERE N_ID_USUARIO = @P_N_ID_USUARIO)

	SET @NOMBRE=(SELECT D_NOMBRE_CONTACTO
	FROM GDD_15.EMPRESAS
	WHERE N_ID_USUARIO = @P_N_ID_USUARIO);

	ELSE

	SET @NOMBRE=(SELECT CONCAT(D_APELLIDOS,', ' ,D_NOMBRES)
	FROM GDD_15.CLIENTES
	WHERE N_ID_USUARIO = @P_N_ID_USUARIO)

	RETURN @NOMBRE

	
END;
GO
--Clientes con mayor cantidad de productos comprados, por mes y por año(TRIMESTRE), dentro de
--un rubro particular

CREATE FUNCTION GDD_15.DEV_CLI_MAYOR_PROD_COMPR(@P_TRIMESTRE  INT,@P_RUBRO varchar(100))
RETURNS @TOP5 TABLE( CLIENTE varchar(300),RUBRO varchar(100),CANTIDAD INT) AS
BEGIN

	INSERT INTO @TOP5	
	SELECT TOP 5 gdd_15.DEV_USUARIO(c.N_ID_CLIENTE ) CLIENTE,
	(select r1.D_DESCRED 
	from GDD_15.RUBROS r1
	where r1.N_ID_RUBRO = r.N_ID_RUBRO)RUBRO,
	SUM(C.N_CANTIDAD)CANT
	 FROM GDD_15.COMPRAS C, GDD_15.PUBLICACIONES P , GDD_15.RUBROS R
	 WHERE  C.N_ID_PUBLICACION= P.N_ID_PUBLICACION
	AND P.N_ID_RUBRO = R.N_ID_RUBRO
	AND R.D_DESCRED = @P_RUBRO
	AND YEAR(C.F_ALTA) = @V_AÑO
	and month(c.f_alta) BETWEEN GDD_15.DEV_F_INICIO_TRI(@V_MES) AND GDD_15.DEV_F_HASTA_TRI(@V_MES) 
	GROUP BY C.N_ID_CLIENTE ,R.N_ID_RUBRO
	ORDER BY  cant desc,CLIENTE DESC;

RETURN
END;
GO

--Vendedores con mayor cantidad de facturas dentro de un mes y año particular
CREATE FUNCTION GDD_15.DEV_VEN_MAYOR_FACT(@P_TRIMESTRE  INT))
RETURNS @TOP5( TABLE CLIENTE varchar(100), CANTIDAD BIGINT) AS
BEGIN
	INSERT INTO @TOP5	
	SELECT TOP 5 gdd_15.DEV_USUARIO(P.N_ID_CLIENTE ) VENDEDOR,
	COUNT(F.N_ID_FACTURA) CANTIDAD
	FROM GDD_15.FACTURAS F, GDD_15.PUBLICACIONES P 
	WHERE P.N_ID_PUBLICACION = F.N_ID_PUBLICACION
	AND YEAR(C.F_ALTA) = @V_AÑO
	and month(c.f_alta) BETWEEN GDD_15.DEV_F_INICIO_TRI(@V_MES) AND GDD_15.DEV_F_HASTA_TRI(@V_MES) 
	GROUP BY P.N_ID_USUARIO
	ORDER BY CANTIDAD DESC;

RETURN
END;
GO