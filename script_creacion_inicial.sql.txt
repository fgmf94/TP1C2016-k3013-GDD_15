/*CREO NUEVO ESQUEMA */
CREATE SCHEMA [GDD_15] AUTHORIZATION [gd];
GO
/*CREO LAS  19 TABLAS DEL DER.
LOS CAMPOS QUE EMPIEZAN CON N_ID SON IDS
N_ NUMEROS
C_ CODIGOS
D_ DESCRIPCIONES 
D_DESCRED DESCRIPCION 
D_DESCRIP DESCRIPCION CORTA
*/
/*CREO LA TABLA DE USUARIOS */
CREATE TABLE GDD_15.USUARIOS (
	N_ID_USUARIO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_USUARIO_NOMBRE VARCHAR(250) UNIQUE,
	C_PASSWORD VARCHAR(250),
	N_CANT_INTENTOS TINYINT DEFAULT 0,
	N_PUBLICACION_GRATIS VARCHAR(2) DEFAULT 'NO',
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE DIRECCIONES */
CREATE TABLE GDD_15.DIRECCIONES (
	N_ID_DIRECCION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_CALLE VARCHAR(100),
	N_NUMERO BIGINT,
	C_PISO VARCHAR(50),
	C_DEPTO VARCHAR(50),
	C_POSTAL VARCHAR(50)
);
GO
/*CREO LA TABLA DE ROLES */
CREATE TABLE GDD_15.ROLES (
	N_ID_ROL BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ROL VARCHAR(100) UNIQUE,
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE ROLES POR USUARIO */
CREATE TABLE GDD_15.ROLES_USUARIOS (
	N_ID_USUARIO BIGINT NOT NULL,
	N_ID_ROL BIGINT NOT NULL,
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES */
CREATE TABLE GDD_15.FUNCIONALIDADES (
	N_ID_FUNCIONALIDAD BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRED VARCHAR(100) UNIQUE,
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES POR ROLES */
CREATE TABLE GDD_15.FUNCIONALIDADES_ROLES (
	N_ID_ROL BIGINT NOT NULL,
	N_ID_FUNCIONALIDAD BIGINT NOT NULL,
);
GO
/*CREO LA TABLA DE RUBROS */
CREATE TABLE GDD_15.RUBROS (
	N_ID_RUBRO BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRIP VARCHAR(50) UNIQUE,
	D_DESCRED VARCHAR(250) UNIQUE
);
GO
/*CREO LA TABLA DE EMPRESAS */
CREATE TABLE GDD_15.EMPRESAS (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_RUBRO BIGINT,
	N_ID_DIRECCION BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT VARCHAR(50),
	D_NOMBRE_CONTACTO VARCHAR(100),
	N_TELEFONO BIGINT,
	C_CORREO VARCHAR(50),
	F_CREACION DATETIME
);
GO
/*CREO LA TABLA DE CLIENTES */
CREATE TABLE GDD_15.CLIENTES (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_DIRECCION BIGINT,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100) NOT NULL,
	D_APELLIDOS VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	F_NACIMIENTO DATETIME,
	N_TELEFONO BIGINT,
	C_CORREO VARCHAR(50),
	N_COMPRA_HABILITADA TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE PUBLICACIONES */
CREATE TABLE GDD_15.PUBLICACIONES (
	N_ID_PUBLICACION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_VISIBILIDAD BIGINT,
	N_ID_USUARIO BIGINT,
	N_ID_RUBRO BIGINT,
	N_ID_ESTADO BIGINT,
	N_ID_TIPO BIGINT,
	D_DESCRED VARCHAR(100),
	N_STOCK INT,
	F_INICIO DATETIME,
	F_VENCIMIENTO DATETIME,
	N_PRECIO FLOAT(24),
	C_PERMITE_ENVIO VARCHAR(2) DEFAULT 'NO'
);
GO
/*CREO LA TABLA DE ESTADOS */
CREATE TABLE GDD_15.ESTADOS (
	N_ID_ESTADO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ESTADO VARCHAR(50),
);
GO
/*CREO LA TABLA DE TIPOS */
CREATE TABLE GDD_15.TIPOS (
	N_ID_TIPO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_TIPO VARCHAR(50),
);
GO
/*CREO LA TABLA DE FACTURAS */
CREATE TABLE GDD_15.FACTURAS (
	N_ID_FACTURA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT NOT NULL,
	C_TIPO_PAGO VARCHAR(50) DEFAULT 'Efectivo',
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE LOS ITEMS DE LAS FACTURAS */
CREATE TABLE GDD_15.FACTURAS_ITEMS (
	N_ID_ITEM BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_FACTURA BIGINT NOT NULL,
	C_VISIBILIDAD BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_COMPRA BIGINT,
	N_MONTO FLOAT(24),
);
GO
/*CREO LA TABLA DE VISIBILIDADES */
CREATE TABLE GDD_15.VISIBILIDADES (
	C_VISIBILIDAD BIGINT IDENTITY(10002,1) PRIMARY KEY ,
	D_DESCRIP VARCHAR(50) UNIQUE,
	N_COMISION_PRECIO FLOAT(24),
	N_COMISION_PORCENTAJE FLOAT(24),
	N_COMISION_ENVIO FLOAT(24),
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE OFERTAS */
CREATE TABLE GDD_15.OFERTAS (
	N_ID_OFERTA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_MONTO FLOAT(24),
	C_GANADOR TINYINT,
	C_ENVIO VARCHAR(2)
);
GO
/*CREO LA TABLA DE COMPRAS */
CREATE TABLE GDD_15.COMPRAS (
	N_ID_COMPRA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_CANTIDAD INT,
	C_ENVIO VARCHAR(2)
);
GO
/*CREO LA TABLA DE CALIFICACIONES */
CREATE TABLE GDD_15.CALIFICACIONES (
	N_ID_CALIFICACION BIGINT PRIMARY KEY ,
	N_ID_COMPRA BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_CLIENTE BIGINT,
	C_CALIFICACION SMALLINT,
	D_DESCRIP VARCHAR(250)
);
GO

/* CREO  LAS PRIMARY KEY COMPUESTAS  */
alter table GDD_15.ROLES_USUARIOS add constraint PK_ROL_POR_USUARIO
	primary key clustered (N_ID_ROL,N_ID_USUARIO);
GO
alter table GDD_15.FUNCIONALIDADES_ROLES add constraint PK_FUNC_POR_ROL
	primary key clustered (N_ID_ROL,N_ID_FUNCIONALIDAD);
GO

/*CREO LAS FOREIGN KEY*/ 

alter table GDD_15.FACTURAS add constraint FK_FACTURA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM
	foreign key (N_ID_FACTURA) references GDD_15.FACTURAS (N_ID_FACTURA);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_VISIBILIDAD
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS (N_ID_OFERTA);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS (N_ID_COMPRA);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRAS_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_VISIB
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS (N_ID_RUBRO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS (N_ID_USUARIO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_ESTADO
	foreign key (N_ID_ESTADO) references GDD_15.ESTADOS (N_ID_ESTADO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_TIPO
	foreign key (N_ID_TIPO) references GDD_15.TIPOS (N_ID_TIPO);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS(N_ID_COMPRA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS(N_ID_OFERTA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS(N_ID_RUBRO);
GO
/*
alter table GDD_15.EMPRESAS add constraint FK_EMPRESA_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLI_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLIENTE_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO*/


--CREO TABLA TEMPORAL QUE ME AYUDA AL MOMENTO DE LA MIGRACION DE CLIENTES Y EMPRESAS--
CREATE TABLE GDD_15.#tmp_usuarios
( 
	n_id_usuario bigint identity(1,1),
	N_ID_DIRECCION BIGINT,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100) ,
	D_APELLIDOS VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	F_NACIMIENTO DATETIME,
	C_CORREO VARCHAR(50),
	N_TELEFONO TINYINT,
	N_ID_RUBRO BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT VARCHAR(50),
	D_NOMBRE_CONTACTO VARCHAR(100),
	F_CREACION DATETIME

);
GO

--CREO TRIGGER EN CLIENTES QUE ME INSERTA EL CLIENTE EN LA TABLA USUARIOS--
create TRIGGER  alta_USUARIO ON gdd_15.CLIENTES 
	 after insert AS
begin
SET IDENTITY_INSERT gdd_15.USUARIOS  ON

	insert into  GDD_15.USUARIOS
	(n_id_usuario,c_usuario_nombre , C_PASSWORD )
	select N_ID_USUARIO, N_DOCUMENTO,(SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256',N_DOCUMENTO)),3,250))
	from inserted
	
	SET IDENTITY_INSERT gdd_15.USUARIOS  off
end;
GO
--CREO TRIGGER EN EMPRESAS QUE ME INSERTA LA EMPRESA EN LA TABLA USUARIOS--
create TRIGGER  alta_USU_EMP  ON gdd_15.EMPRESAS 
	 after insert AS
begin
SET IDENTITY_INSERT gdd_15.USUARIOS  ON

	insert into  GDD_15.USUARIOS
	(n_id_usuario,c_usuario_nombre , C_PASSWORD )
	select N_ID_USUARIO, N_CUIT, (SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256',N_CUIT)),3,250))
	from inserted
	
	SET IDENTITY_INSERT gdd_15.USUARIOS  off
end;
GO

CREATE PROCEDURE GDD_15.MIGRO_DIRECCIONES AS 
BEGIN
	/* INSERTO DIRECCIONES DE LOS CLIENTES */
	INSERT INTO GDD_15.DIRECCIONES 
	(
		C_CALLE,
		N_NUMERO,
		C_DEPTO,
		C_PISO,
		C_POSTAL
	)
	select DISTINCT Cli_Dom_Calle,
					Cli_Nro_Calle,
					Cli_Depto,
					Cli_Piso,
					Cli_Cod_Postal
	FROM gd_esquema.Maestra
	WHERE Cli_Dni IS NOT NULL;

	/* INSERTO DIRECCIONES DE LOS EMPRESAS */
	INSERT INTO GDD_15.DIRECCIONES 
	(
		C_CALLE,
		N_NUMERO,
		C_DEPTO,
		C_PISO,
		C_POSTAL
	)
	SELECT DISTINCT Publ_Empresa_Dom_Calle,
					Publ_Empresa_Nro_Calle,
					Publ_Empresa_Piso,
					Publ_Empresa_Depto,
					Publ_Empresa_Cod_Postal
	FROM gd_esquema.Maestra 
	WHERE Publ_Empresa_Cuit IS NOT NULL;
END;
GO

-- PRC QUE MIGRA CLIENTES Y EMPRESAS ---
CREATE PROCEDURE GDD_15.MIGRO_USUARIOS AS
BEGIN
	/*  INSERTO CLIENTES  en la tmp_usuarios*/
	INSERT INTO #tmp_usuarios
	(	
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION, 
		C_CORREO
	)
	SELECT DISTINCT m.Cli_Dni,
					'DNI',					
					m.Cli_Apeliido,
					m.Cli_Nombre,
					CONVERT(CHAR(10),Cli_Fecha_Nac,103)fecha_nac,
					d.N_ID_DIRECCION, 
					M.Cli_Mail
	FROM gd_esquema.Maestra m, gdd_15.DIRECCIONES d
	WHERE m.Cli_Dni IS NOT NULL
	and d.n_numero=m.Cli_Nro_Calle
	and d.c_piso=convert(varchar(50),m.Cli_Piso)
	and d.C_DEPTO=convert(varchar(50),m.Cli_Depto)
	and d.C_CALLE=m.Cli_Dom_Calle;
	
	/*INSERTO EMPRESAS  en la tmp_usuarios*/
	INSERT INTO #tmp_usuarios
	(
		
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
	)
	SELECT DISTINCT m.Publ_Empresa_Cuit,
					CONVERT(CHAR(10),Publ_Empresa_Fecha_Creacion,103)fecha_CREAC,
					m.Publ_Empresa_Mail,
					m.Publ_Empresa_Razon_Social,
					d.N_ID_DIRECCION
	FROM gd_esquema.Maestra m, gdd_15.DIRECCIONES d
	WHERE Publ_Empresa_Cuit IS NOT NULL
	and d.n_numero=m.Publ_Empresa_Nro_Calle
	and d.C_CALLE=m.Publ_Empresa_Dom_Calle;
	--and d.c_piso=convert(varchar(50),m.Publ_Empresa_Piso)
	--and d.C_DEPTO=convert(varchar(50),m.Publ_Empresa_Depto);

/*INSERTO CLIENTES */
	INSERT INTO GDD_15.CLIENTES
	(	N_ID_USUARIO,
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION,
		C_CORREO
	)
select	N_ID_USUARIO,
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION,
		C_CORREO 
		from #tmp_usuarios
where N_DOCUMENTO is not null;
	
/*INSERTO EMPRESAS*/
	INSERT INTO GDD_15.EMPRESAS
	(
		N_ID_USUARIO,
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
	)
SELECT N_ID_USUARIO,
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
		FROM #tmp_usuarios
		WHERE N_CUIT IS NOT NULL;
END;
GO

/*Inserto las funcionalidades*/

INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rol');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Usuarios');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rubro');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de visibilidad de publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Generar Publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Comprar/Ofertar');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Historial');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Calificar al Vendedor');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Consulta de facturas');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Listado Estadístico');
GO

/*Creo el rol Administrativo*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Administrativo');
GO


/*Se agregan funcionalidades al rol Administrativo*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Administrativo' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Rol', 'ABM de Usuarios', 'ABM de Rubro', 'ABM de visibilidad de publicación', 'Listado Estadístico');
GO

/*Creo el rol Cliente*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Cliente');
GO

/*Se agregan funcionalidades al rol Cliente*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Cliente' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'Generar Publicación', 'Comprar/Ofertar', 'Historial', 'Calificar al Vendedor', 'Consulta de facturas', 'Listado Estadístico');
GO

/*Creo el rol Empresa*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Empresa');
GO

/*Se agregan funcionalidades al rol Empresa*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Empresa' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'Generar Publicación', 'Consulta de facturas', 'Listado Estadístico');
GO



/* Cargo las visibilidades */

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Platino', 180, 0.10, 20

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Oro', 140, 0.15, 30

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Plata', 100, 0.20, 40

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Bronze', 60, 0.30, 50

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Gratis', 0, 0, 0


--Inserto los tipos de Publicacion--
INSERT INTO GDD_15.TIPOS(C_TIPO) VALUES ('Subasta');
INSERT INTO GDD_15.TIPOS(C_TIPO) VALUES ('Compra Inmediata');

--Inserto los estados de una Publicacion--
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Publicada');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Borrador');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Activa');--- tengo la duda si activa es lo mismo que publicada ?--
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Pausada');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Finalizada');

--INICIO MIGRACION --
EXEC GDD_15.MIGRO_DIRECCIONES;
EXEC GDD_15.MIGRO_USUARIOS;
-- FIN MIGRACION --

DROP TABLE dbo.#tmp_usuarios;
GO
DROP TRIGGER GDD_15.alta_USUARIO;
GO
DROP TRIGGER GDD_15.alta_USU_EMP;
GO

/* Se inserta el usuario admin, password w23e */

INSERT INTO GDD_15.USUARIOS(C_USUARIO_NOMBRE,C_PASSWORD)
VALUES ('admin',(SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256','w23e')),3,250) ))
GO

/* Se le asignan todos los roles al usuario admin */

INSERT INTO GDD_15.ROLES_USUARIOS(N_ID_USUARIO, N_ID_ROL)
SELECT tablaUsuarios.N_ID_USUARIO, tablaRoles.N_ID_ROL FROM GDD_15.USUARIOS tablaUsuarios, GDD_15.ROLES tablaRoles
WHERE tablaUsuarios.C_USUARIO_NOMBRE = 'admin'
GO

CREATE TRIGGER  BAJA_ROL ON GDD_15.ROLES 
AFTER UPDATE AS
BEGIN
	-- Declaracion de variables para el cursor
	DECLARE	@N_ID_ROL BIGINT,
			@N_HABILITADO TINYINT
	-- Declaración del cursor
	DECLARE cROLES CURSOR FOR
	SELECT N_ID_ROL, N_HABILITADO
	FROM INSERTED
	-- Apertura del cursor
	OPEN cROLES
	-- Lectura de la primera fila del cursor
	FETCH cROLES INTO @N_ID_ROL, @N_HABILITADO
	WHILE (@@FETCH_STATUS = 0 )
		BEGIN
			-- Si el rol queda deshabilitado, actualiza la tabla de roles_usuarios
			IF @N_HABILITADO = 0
			BEGIN
				UPDATE ROLES_USUARIOS
				SET N_HABILITADO = 0
				WHERE N_ID_ROL = @N_ID_ROL
			END
			
			-- Lectura de la siguiente fila del cursor
			FETCH cROLES INTO @N_ID_ROL, @N_HABILITADO
		END
	-- Cierre del cursor
	CLOSE cROLES
	-- Liberar los recursos
	DEALLOCATE cROLES
END;
GO

 --MIGRO RUBROS--
INSERT INTO GDD_15.RUBROS
(D_DESCRED, D_DESCRIP)
SELECT  DISTINCT Publicacion_Rubro_Descripcion,
CASE 
WHEN Publicacion_Rubro_Descripcion = 'Audio para el Hogar' THEN 'AUDI1'
WHEN Publicacion_Rubro_Descripcion = 'Audio Portátil y Radios' THEN 'AUDI2'
WHEN Publicacion_Rubro_Descripcion = 'Audio / Video Profesional y DJ' THEN 'AUDI3'
ELSE SUBSTRING(UPPER(Publicacion_Rubro_Descripcion),1,5)
END AS Publicacion_Rubro_Descripcion
FROM gd_esquema.Maestra m 
WHERE Publicacion_Rubro_Descripcion IS NOT NULL
ORDER BY 1 
GO

/*
--MIGRO COMPRAS --
--INSERTO COMPRAS --
INSERT INTO GDD_15.COMPRAS
(
	N_ID_PUBLICACION,
	N_ID_CLIENTE,
	N_CANTIDAD,
	F_ALTA
)
 SELECT DISTINCT M.Publicacion_Cod,
 (SELECT C.N_ID_USUARIO 
	 FROM GDD_15.CLIENTES C
	 WHERE C.N_DOCUMENTO = M.Cli_Dni) N_ID_CLIENTE,
 Compra_Cantidad,
 Compra_Fecha
  FROM gd_esquema.Maestra m
  WHERE COMPRA_CANTIDAD IS NOT NULL
  ORDER BY Publicacion_Cod ASC, N_ID_CLIENTE asc ;
--MIGRO OFERTAS--
  --INSERTO OFERTAS---
  INSERT INTO GDD_15.OFERTAS
(
	N_ID_PUBLICACION,
	N_ID_CLIENTE,
	N_MONTO,
	F_ALTA
)
	SELECT DISTINCT M.Publicacion_Cod,
			(SELECT C.N_ID_USUARIO 
				FROM GDD_15.CLIENTES C
				WHERE C.N_DOCUMENTO = M.Cli_Dni) N_ID_CLIENTE,
			Oferta_Monto,
			Oferta_Fecha
  FROM gd_esquema.Maestra m
  WHERE Oferta_Monto IS NOT NULL
  ORDER BY Publicacion_Cod ASC , N_ID_CLIENTE ASC ;

--MIGRO FACTURAS--
--INSERTO FACTURAS --
SET IDENTITY_INSERT gdd_15.FACTURAS  oN
INSERT INTO GDD_15.FACTURAS
(
	N_ID_FACTURA,
	N_ID_PUBLICACION,
	F_ALTA,
	C_TIPO_PAGO
 )
select	DISTINCT factura_nro,
		Publicacion_Cod,
		Factura_Fecha,
		--Factura_Total,
		Forma_Pago_Desc
from gd_esquema.Maestra
where Factura_Nro is not null 
ORDER BY 1,2
SET IDENTITY_INSERT gdd_15.FACTURAS  oFF
--MIGRO ITEMS DE LAS FACTURAS -- FALTA TERMINAR!!
INSERT INTO GDD_15.FACTURAS_ITEMS
(
	N_ID_FACTURA,
	C_VISIBILIDAD,
	--N_ID_COMPRA
	N_MONTO
 )
select	DISTINCT M.factura_nro,
		M.Publicacion_Visibilidad_Cod,
		Item_Factura_Monto
from gd_esquema.Maestra M
where M.Factura_Nro is not null 
ORDER BY M.Factura_Nro ASC;

--MIGRO CALIFICACIONES--
/*CREO TMP DE CALIFICACIONES 
CREATE TABLE GDD_15.#TMP_CALIFICACIONES (
	N_ID_CALIFICACION BIGINT PRIMARY KEY ,
	N_ID_PUBLICACION BIGINT,
	N_ID_COMPRA BIGINT,
	N_ID_CLIENTE BIGINT,
	C_CALIFICACION SMALLINT,
	D_DESCRIP VARCHAR(250)
);
GO

INSERT INTO #tmp_calificaciones
(	N_ID_PUBLICACION,
	N_ID_CALIFICACION,
	D_DESCRIP,
	C_CALIFICACION 	
)
SELECT  DISTINCT Publicacion_Cod,
Calificacion_Codigo,
		Calificacion_Descripcion,
		Calificacion_Cant_Estrellas
FROM gd_esquema.Maestra m 
WHERE M.Calificacion_Codigo IS NOT NULL

 SELECT * FROM  #TMP_CALIFICACIONES

INSERT INTO #tmp_calificaciones
(N_ID_COMPRA,N_ID_CLIENTE)
SELECT DISTINCT C.N_ID_COMPRA,C.N_ID_CLIENTE 
 FROM GDD_15.COMPRAS C,#TMP_CALIFICACIONES T
WHERE C.N_ID_PUBLICACION = T.N_ID_PUBLICACION*/
*/

/*CREO LA TABLA DE USUARIOS */
CREATE TABLE GDD_15.USUARIOS (
	N_ID_USUARIO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_USUARIO_NOMBRE VARCHAR(250) UNIQUE,
	C_PASSWORD VARCHAR(250),
	N_CANT_INTENTOS TINYINT DEFAULT 0,
	N_PUBLICACION_GRATIS VARCHAR(2) DEFAULT 'NO',
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE DIRECCIONES */
CREATE TABLE GDD_15.DIRECCIONES (
	N_ID_DIRECCION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_CALLE VARCHAR(100),
	N_NUMERO BIGINT,
	C_PISO VARCHAR(50),
	C_DEPTO VARCHAR(50),
	C_POSTAL VARCHAR(50)
);
GO
/*CREO LA TABLA DE ROLES */
CREATE TABLE GDD_15.ROLES (
	N_ID_ROL BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ROL VARCHAR(100) UNIQUE,
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE ROLES POR USUARIO */
CREATE TABLE GDD_15.ROLES_USUARIOS (
	N_ID_USUARIO BIGINT NOT NULL,
	N_ID_ROL BIGINT NOT NULL,
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES */
CREATE TABLE GDD_15.FUNCIONALIDADES (
	N_ID_FUNCIONALIDAD BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRED VARCHAR(100) UNIQUE,
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES POR ROLES */
CREATE TABLE GDD_15.FUNCIONALIDADES_ROLES (
	N_ID_ROL BIGINT NOT NULL,
	N_ID_FUNCIONALIDAD BIGINT NOT NULL,
);
GO
/*CREO LA TABLA DE RUBROS */
CREATE TABLE GDD_15.RUBROS (
	N_ID_RUBRO BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRIP VARCHAR(50) UNIQUE,
	D_DESCRED VARCHAR(250) UNIQUE
);
GO
/*CREO LA TABLA DE EMPRESAS */
CREATE TABLE GDD_15.EMPRESAS (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_RUBRO BIGINT,
	N_ID_DIRECCION BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT VARCHAR(50),
	D_NOMBRE_CONTACTO VARCHAR(100),
	N_TELEFONO BIGINT,
	C_CORREO VARCHAR(50),
	F_CREACION DATETIME
);
GO
/*CREO LA TABLA DE CLIENTES */
CREATE TABLE GDD_15.CLIENTES (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_DIRECCION BIGINT,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100) NOT NULL,
	D_APELLIDOS VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	F_NACIMIENTO DATETIME,
	N_TELEFONO BIGINT,
	C_CORREO VARCHAR(50),
	N_COMPRA_HABILITADA TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE PUBLICACIONES */
CREATE TABLE GDD_15.PUBLICACIONES (
	N_ID_PUBLICACION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_VISIBILIDAD BIGINT,
	N_ID_USUARIO BIGINT,
	N_ID_RUBRO BIGINT,
	N_ID_ESTADO BIGINT,
	N_ID_TIPO BIGINT,
	D_DESCRED VARCHAR(100),
	N_STOCK INT,
	F_INICIO DATETIME,
	F_VENCIMIENTO DATETIME,
	N_PRECIO FLOAT(24),
	C_PERMITE_ENVIO VARCHAR(2) DEFAULT 'NO'
);
GO
/*CREO LA TABLA DE ESTADOS */
CREATE TABLE GDD_15.ESTADOS (
	N_ID_ESTADO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ESTADO VARCHAR(50),
);
GO
/*CREO LA TABLA DE TIPOS */
CREATE TABLE GDD_15.TIPOS (
	N_ID_TIPO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_TIPO VARCHAR(50),
);
GO
/*CREO LA TABLA DE FACTURAS */
CREATE TABLE GDD_15.FACTURAS (
	N_ID_FACTURA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT NOT NULL,
	C_TIPO_PAGO VARCHAR(50) DEFAULT 'Efectivo',
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE LOS ITEMS DE LAS FACTURAS */
CREATE TABLE GDD_15.FACTURAS_ITEMS (
	N_ID_ITEM BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_FACTURA BIGINT NOT NULL,
	C_VISIBILIDAD BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_COMPRA BIGINT,
	N_MONTO FLOAT(24),
);
GO
/*CREO LA TABLA DE VISIBILIDADES */
CREATE TABLE GDD_15.VISIBILIDADES (
	C_VISIBILIDAD BIGINT IDENTITY(10002,1) PRIMARY KEY ,
	D_DESCRIP VARCHAR(50) UNIQUE,
	N_COMISION_PRECIO FLOAT(24),
	N_COMISION_PORCENTAJE FLOAT(24),
	N_COMISION_ENVIO FLOAT(24),
	N_HABILITADO TINYINT DEFAULT 1
);
GO
/*CREO LA TABLA DE OFERTAS */
CREATE TABLE GDD_15.OFERTAS (
	N_ID_OFERTA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_MONTO FLOAT(24),
	C_GANADOR TINYINT,
	C_ENVIO VARCHAR(2)
);
GO
/*CREO LA TABLA DE COMPRAS */
CREATE TABLE GDD_15.COMPRAS (
	N_ID_COMPRA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_CANTIDAD INT,
	C_ENVIO VARCHAR(2)
);
GO
/*CREO LA TABLA DE CALIFICACIONES */
CREATE TABLE GDD_15.CALIFICACIONES (
	N_ID_CALIFICACION BIGINT PRIMARY KEY ,
	N_ID_COMPRA BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_CLIENTE BIGINT,
	C_CALIFICACION SMALLINT,
	D_DESCRIP VARCHAR(250)
);
GO

/* CREO  LAS PRIMARY KEY COMPUESTAS  */
alter table GDD_15.ROLES_USUARIOS add constraint PK_ROL_POR_USUARIO
	primary key clustered (N_ID_ROL,N_ID_USUARIO);
GO
alter table GDD_15.FUNCIONALIDADES_ROLES add constraint PK_FUNC_POR_ROL
	primary key clustered (N_ID_ROL,N_ID_FUNCIONALIDAD);
GO

/*CREO LAS FOREIGN KEY*/ 

alter table GDD_15.FACTURAS add constraint FK_FACTURA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM
	foreign key (N_ID_FACTURA) references GDD_15.FACTURAS (N_ID_FACTURA);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_VISIBILIDAD
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS (N_ID_OFERTA);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS (N_ID_COMPRA);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRAS_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
-- FK publicaciones--
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_VISIB
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS (N_ID_RUBRO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS (N_ID_USUARIO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_ESTADO
	foreign key (N_ID_ESTADO) references GDD_15.ESTADOS (N_ID_ESTADO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_TIPO
	foreign key (N_ID_TIPO) references GDD_15.TIPOS (N_ID_TIPO);
GO

alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS(N_ID_COMPRA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS(N_ID_OFERTA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS(N_ID_RUBRO);
GO

alter table GDD_15.EMPRESAS add constraint FK_EMPRESA_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLI_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLIENTE_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO


--CREO TABLA TEMPORAL QUE ME AYUDA AL MOMENTO DE LA MIGRACION DE CLIENTES Y EMPRESAS--
CREATE TABLE GDD_15.#tmp_usuarios
( 
	n_id_usuario bigint identity(1,1),
	N_ID_DIRECCION BIGINT,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100) ,
	D_APELLIDOS VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	F_NACIMIENTO DATETIME,
	C_CORREO VARCHAR(50),
	N_TELEFONO TINYINT,
	N_ID_RUBRO BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT VARCHAR(50),
	D_NOMBRE_CONTACTO VARCHAR(100),
	F_CREACION DATETIME

);
GO

/*CREO TMP DE CALIFICACIONES */
CREATE TABLE GDD_15.#TMP_CALIFICACIONES (
N_ID_PUBLICACION BIGINT,
	N_ID_CALIFICACION BIGINT PRIMARY KEY,
	N_ID_COMPRA BIGINT,
	N_ID_OFERTA	BIGINT,
	N_ID_CLIENTE BIGINT,
	C_CALIFICACION SMALLINT,
	D_DESCRIP VARCHAR(250)
);
GO



--CREO TRIGGER EN CLIENTES QUE ME INSERTA EL CLIENTE EN LA TABLA USUARIOS--
create TRIGGER  alta_USUARIO ON gdd_15.CLIENTES 
	 after insert AS
begin
SET IDENTITY_INSERT gdd_15.USUARIOS  ON
  
	insert into  GDD_15.USUARIOS
	(n_id_usuario,c_usuario_nombre , C_PASSWORD )
	select N_ID_USUARIO, N_DOCUMENTO,(SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256',N_DOCUMENTO)),3,250))
	from inserted
	
	SET IDENTITY_INSERT gdd_15.USUARIOS  off
end;
GO
--CREO TRIGGER EN EMPRESAS QUE ME INSERTA LA EMPRESA EN LA TABLA USUARIOS--
create TRIGGER  alta_USU_EMP  ON gdd_15.EMPRESAS 
	 after insert AS
begin
SET IDENTITY_INSERT gdd_15.USUARIOS  ON

	insert into  GDD_15.USUARIOS
	(n_id_usuario,c_usuario_nombre , C_PASSWORD )
	select N_ID_USUARIO, N_CUIT, (SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256',N_CUIT)),3,250))
	from inserted
	
	SET IDENTITY_INSERT gdd_15.USUARIOS  off
end;
GO

CREATE PROCEDURE GDD_15.MIGRO_DIRECCIONES AS 
BEGIN
	/* INSERTO DIRECCIONES DE LOS CLIENTES */
	INSERT INTO GDD_15.DIRECCIONES 
	(
		C_CALLE,
		N_NUMERO,
		C_DEPTO,
		C_PISO,
		C_POSTAL
	)
	select DISTINCT Cli_Dom_Calle,
					Cli_Nro_Calle,
					Cli_Depto,
					Cli_Piso,
					Cli_Cod_Postal
	FROM gd_esquema.Maestra
	WHERE Cli_Dni IS NOT NULL;

	/* INSERTO DIRECCIONES DE LOS EMPRESAS */
	INSERT INTO GDD_15.DIRECCIONES 
	(
		C_CALLE,
		N_NUMERO,
		C_DEPTO,
		C_PISO,
		C_POSTAL
	)
	SELECT DISTINCT Publ_Empresa_Dom_Calle,
					Publ_Empresa_Nro_Calle,
					Publ_Empresa_Piso,
					Publ_Empresa_Depto,
					Publ_Empresa_Cod_Postal
	FROM gd_esquema.Maestra 
	WHERE Publ_Empresa_Cuit IS NOT NULL;
END;
GO

-- PRC QUE MIGRA CLIENTES Y EMPRESAS ---
CREATE PROCEDURE GDD_15.MIGRO_USUARIOS AS
BEGIN
	/*  INSERTO CLIENTES  en la tmp_usuarios*/
	INSERT INTO #tmp_usuarios
	(	
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION, 
		C_CORREO
	)
	SELECT DISTINCT m.Cli_Dni,
					'DNI',					
					m.Cli_Apeliido,
					m.Cli_Nombre,
					CONVERT(CHAR(10),Cli_Fecha_Nac,103)fecha_nac,
					d.N_ID_DIRECCION, 
					M.Cli_Mail
	FROM gd_esquema.Maestra m, gdd_15.DIRECCIONES d
	WHERE m.Cli_Dni IS NOT NULL
	and d.n_numero=m.Cli_Nro_Calle
	and d.c_piso=convert(varchar(50),m.Cli_Piso)
	and d.C_DEPTO=convert(varchar(50),m.Cli_Depto)
	and d.C_CALLE=m.Cli_Dom_Calle;
	
	/*INSERTO EMPRESAS  en la tmp_usuarios*/
	INSERT INTO #tmp_usuarios
	(
		
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
	)
	SELECT DISTINCT m.Publ_Empresa_Cuit,
					CONVERT(CHAR(10),Publ_Empresa_Fecha_Creacion,103)fecha_CREAC,
					m.Publ_Empresa_Mail,
					m.Publ_Empresa_Razon_Social,
					d.N_ID_DIRECCION		
	FROM gd_esquema.Maestra m, gdd_15.DIRECCIONES d 
	WHERE Publ_Empresa_Cuit IS NOT NULL
	and d.n_numero=m.Publ_Empresa_Nro_Calle
	and d.C_CALLE=m.Publ_Empresa_Dom_Calle;


	alter TABLE GDD_15.CLIENTES 
	NOCHECK CONSTRAINT FK_CLIENTE_USUARIO;
/*INSERTO CLIENTES */
	INSERT INTO GDD_15.CLIENTES
	(	N_ID_USUARIO,
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION,
		C_CORREO
	)
select	N_ID_USUARIO,
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION,
		C_CORREO 
		from #tmp_usuarios
where N_DOCUMENTO is not null;

	alter TABLE GDD_15.EMPRESAS 
	NOCHECK CONSTRAINT FK_EMPRESA_USUARIO;

/*INSERTO EMPRESAS*/
	INSERT INTO GDD_15.EMPRESAS
	(
		N_ID_USUARIO,
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
	)
SELECT N_ID_USUARIO,
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
		FROM #tmp_usuarios
		WHERE N_CUIT IS NOT NULL
		;
END;
GO

 -- PRC QUE MIGRA LOS RUBROS--
CREATE PROCEDURE GDD_15.MIGRO_RUBROS AS
BEGIN
	INSERT INTO GDD_15.RUBROS
	(D_DESCRED, D_DESCRIP)
	SELECT  DISTINCT Publicacion_Rubro_Descripcion,
	CASE 
	WHEN Publicacion_Rubro_Descripcion = 'Audio para el Hogar' THEN 'AUDI1'
	WHEN Publicacion_Rubro_Descripcion = 'Audio Portátil y Radios' THEN 'AUDI2'
	WHEN Publicacion_Rubro_Descripcion = 'Audio / Video Profesional y DJ' THEN 'AUDI3'
	ELSE SUBSTRING(UPPER(Publicacion_Rubro_Descripcion),1,5)
	END AS Publicacion_Rubro_Descripcion
	FROM gd_esquema.Maestra m 
	WHERE Publicacion_Rubro_Descripcion IS NOT NULL
	ORDER BY 1; 
END;
GO
CREATE PROCEDURE GDD_15.CARGO_ESTADO_TIPO_VISI AS
BEGIN
/* Cargo las visibilidades */

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Platino', 180, 0.10, 20

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Oro', 140, 0.15, 30

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Plata', 100, 0.20, 40

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Bronze', 60, 0.30, 50

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Gratis', 0, 0, 0


--Inserto los tipos de Publicacion--
INSERT INTO GDD_15.TIPOS(C_TIPO) VALUES ('Subasta');
INSERT INTO GDD_15.TIPOS(C_TIPO) VALUES ('Compra Inmediata');

--Inserto los estados de una Publicacion--
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Publicada');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Borrador');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Activa');--- tengo la duda si activa es lo mismo que publicada ?--
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Pausada');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Finalizada');
END;
GO

--MIGRO PUBLICACIONES--
CREATE PROCEDURE GDD_15.MIGRO_PUBLICACIONES AS
BEGIN
	INSERT INTO GDD_15.PUBLICACIONES
	(
		C_VISIBILIDAD,
		N_ID_USUARIO,
		N_ID_RUBRO,
		N_ID_ESTADO,
		n_id_tipo,
		D_DESCRED,
		N_STOCK,
		F_INICIO,
		F_VENCIMIENTO,
		N_PRECIO
	)
	select distinct 
			M.Publicacion_Visibilidad_Cod ,
			case when m.publ_cli_dni is not null
			 then(select c.n_id_usuario 
					from GDD_15.CLIENTES c
					where c.N_DOCUMENTO = m.publ_cli_dni)
			else
				(select e.n_id_usuario
				from GDD_15.EMPRESAS e 
				where e.N_CUIT = m.Publ_Empresa_Cuit)
			end N_ID_USUARIO,
			(SELECT  R.N_ID_RUBRO FROM GDD_15. RUBROS R
			WHERE M.Publicacion_Rubro_Descripcion = R.D_DESCRED  )N_ID_RUBRO,
			(SELECT  E.N_ID_ESTADO FROM GDD_15.ESTADOS E
			WHERE M.Publicacion_Estado = E.C_ESTADO)N_ID_ESTADO,
			(SELECT T.N_ID_TIPO FROM GDD_15.TIPOS T
			WHERE M.PUBLICACION_TIPO = T.C_TIPO) N_ID_TIPO,
			Publicacion_Descripcion,
			Publicacion_Stock,
			Publicacion_Fecha,
			Publicacion_Fecha_Venc,
			Publicacion_Precio
	FROM gd_esquema.Maestra m
	WHERE Publicacion_Cod IS NOT NULL;
END;
GO

--MIGRO COMPRAS --
CREATE PROCEDURE GDD_15.MIGRO_COMPRAS AS
BEGIN

	
	alter TABLE GDD_15.COMPRAS
	NOCHECK CONSTRAINT FK_COMPRA_PUBL;
	--INSERTO COMPRAS --
	INSERT INTO GDD_15.COMPRAS
	(
		N_ID_PUBLICACION,
		N_ID_CLIENTE,
		N_CANTIDAD,
		F_ALTA
	)
	 SELECT DISTINCT M.Publicacion_Cod,
	 (SELECT C.N_ID_USUARIO 
		 FROM GDD_15.CLIENTES C
		 WHERE C.N_DOCUMENTO = M.Cli_Dni) N_ID_CLIENTE,
	 Compra_Cantidad,
	 Compra_Fecha
	  FROM gd_esquema.Maestra m
	  WHERE COMPRA_CANTIDAD IS NOT NULL
	  ORDER BY Publicacion_Cod ASC, N_ID_CLIENTE asc ;
END;
GO
--MIGRO OFERTAS--
CREATE PROCEDURE GDD_15.MIGRO_OFERTAS AS 
BEGIN
alter TABLE GDD_15.OFERTAS
	NOCHECK CONSTRAINT FK_OFERTA_PUBL;
	  --INSERTO OFERTAS---
	  INSERT INTO GDD_15.OFERTAS
	(
		N_ID_PUBLICACION,
		N_ID_CLIENTE,
		N_MONTO,
		F_ALTA
	)
		SELECT DISTINCT M.Publicacion_Cod,
				(SELECT C.N_ID_USUARIO 
					FROM GDD_15.CLIENTES C
					WHERE C.N_DOCUMENTO = M.Cli_Dni) N_ID_CLIENTE,
				Oferta_Monto,
				Oferta_Fecha
	  FROM gd_esquema.Maestra m
	  WHERE Oferta_Monto IS NOT NULL
	  ORDER BY Publicacion_Cod ASC , N_ID_CLIENTE ASC ;
END;
GO
--MIGRO FACTURAS--
CREATE PROCEDURE GDD_15.MIGRO_FACTURAS AS
BEGIN
	alter TABLE GDD_15.FACTURAS
	NOCHECK CONSTRAINT FK_FACTURA_PUBL;
	--INSERTO FACTURAS --
	SET IDENTITY_INSERT gdd_15.FACTURAS  oN
	INSERT INTO GDD_15.FACTURAS
	(
		N_ID_FACTURA,
		N_ID_PUBLICACION,
		F_ALTA,
		C_TIPO_PAGO
	 )
	select	DISTINCT factura_nro,
			Publicacion_Cod,
			Factura_Fecha,
			--Factura_Total,
			Forma_Pago_Desc
	from gd_esquema.Maestra
	where Factura_Nro is not null 
	ORDER BY 1,2

SET IDENTITY_INSERT gdd_15.FACTURAS  oFF


/*-MIGRO ITEMS DE LAS FACTURAS --
	INSERT INTO GDD_15.FACTURAS_ITEMS
	(
		N_ID_FACTURA,
		C_VISIBILIDAD,
		--N_ID_COMPRA
		N_MONTO
	 )
	select	DISTINCT M.factura_nro,
			M.Publicacion_Visibilidad_Cod,
DEV_COMPRA( M.Publicacion_Cod)N_ID_COMPRA,
			Item_Factura_Monto
	from gd_esquema.Maestra M
	where M.Factura_Nro is not null 
	ORDER BY M.Factura_Nro ASC;*/

END;
GO
CREATE PROCEDURE GDD_15.MIGRO_CALIFICACIONES AS
BEGIN

	INSERT INTO #tmp_calificaciones
	(
		N_ID_PUBLICACION,
		N_ID_COMPRA,
	--_ID_OFERTA,
		N_ID_CLIENTE,
		N_ID_CALIFICACION,
		D_DESCRIP,
		C_CALIFICACION 	
	)
	SELECT  DISTINCT PUBLICACION_COD,
	C.N_ID_COMPRA,
	case when m.publ_cli_dni is not null
	then(select c.n_id_usuario 
		from GDD_15.CLIENTES c
		where c.N_DOCUMENTO = m.publ_cli_dni)
	else
	(select e.n_id_usuario
	from GDD_15.EMPRESAS e 
	where e.N_CUIT = m.Publ_Empresa_Cuit)
	end N_ID_USUARIO,
	Calificacion_Codigo,
	Calificacion_Descripcion,
	Calificacion_Cant_Estrellas
	FROM gd_esquema.Maestra m ,GDD_15.COMPRAS C
	WHERE M.Calificacion_Codigo IS NOT NULL
	AND M.Publicacion_Cod = C.N_ID_PUBLICACION
	AND M.Compra_Cantidad = C.N_CANTIDAD
	AND M.Compra_Fecha = C.F_ALTA;
END;
GO
/* PROCEDURES DEL DOMINIO */

CREATE PROCEDURE GDD_15.AGREGARPUBLICACION @usuarioID BIGINT, @rubroID BIGINT, @visiID BIGINT, @estadoID BIGINT, @tipoID BIGINT, @descrip VARCHAR(100), @stock INT, @fecha_inicio DATETIME, @fecha_ven DATETIME, @precio FLOAT(24), @permite_envio VARCHAR(2)
AS
BEGIN
	DECLARE @visiDesc VARCHAR(50), @precioVisi FLOAT(24), @estado VARCHAR(50)
	SELECT @visiDesc = D_DESCRIP, @precioVisi = N_COMISION_PRECIO FROM GDD_15.VISIBILIDADES WHERE C_VISIBILIDAD = @visiID
	SELECT @estado = C_ESTADO FROM GDD_15.ESTADOS WHERE N_ID_ESTADO = @estadoID
	IF (@estado = 'Borrador')
	BEGIN
		INSERT INTO GDD_15.PUBLICACIONES(N_ID_USUARIO, N_ID_RUBRO, C_VISIBILIDAD, N_ID_ESTADO, N_ID_TIPO, D_DESCRED, N_STOCK, F_INICIO, F_VENCIMIENTO, N_PRECIO, C_PERMITE_ENVIO) VALUES (@usuarioID , @rubroID, + @visiID, @estadoID, @tipoID, @descrip, @stock, @fecha_inicio, @fecha_ven, @precio, @permite_envio)
	END
	ELSE IF  (@estado = 'Activa')
	BEGIN
		DECLARE @publiID BIGINT, @facturaID BIGINT
		INSERT INTO GDD_15.PUBLICACIONES(N_ID_USUARIO, N_ID_RUBRO, C_VISIBILIDAD, N_ID_ESTADO, N_ID_TIPO, D_DESCRED, N_STOCK, F_INICIO, F_VENCIMIENTO, N_PRECIO, C_PERMITE_ENVIO) VALUES (@usuarioID , @rubroID, + @visiID, @estadoID, @tipoID, @descrip, @stock, @fecha_inicio, @fecha_ven, @precio, @permite_envio)
		SELECT @publiID = SCOPE_IDENTITY()
		INSERT INTO GDD_15.FACTURAS(N_ID_PUBLICACION, F_ALTA) VALUES (@publiID,@fecha_inicio)
		SELECT @facturaID = SCOPE_IDENTITY()
		INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, C_VISIBILIDAD, N_MONTO) VALUES (@facturaID, @visiID, @precioVisi)
	END
END;
GO

CREATE PROCEDURE GDD_15.COMPRAR @publiID BIGINT, @usuarioID BIGINT, @fecha_alta DATETIME, @cantidad INT, @envio VARCHAR(2)
AS
BEGIN
	DECLARE @visiID BIGINT, @porcentajeVisi FLOAT(24), @envioVisi FLOAT(24), @facturaID BIGINT, @precioPubli FLOAT(24), @compraID BIGINT, @stock INT
	SELECT @visiID = C_VISIBILIDAD, @precioPubli = N_PRECIO, @stock = N_STOCK FROM GDD_15.PUBLICACIONES WHERE N_ID_PUBLICACION = @publiID
	SELECT @porcentajeVisi = N_COMISION_PORCENTAJE, @envioVisi = N_COMISION_ENVIO FROM GDD_15.VISIBILIDADES WHERE C_VISIBILIDAD = @visiID
	INSERT INTO GDD_15.COMPRAS(N_ID_PUBLICACION,N_ID_CLIENTE,F_ALTA,N_CANTIDAD,C_ENVIO) VALUES (@publiID, @usuarioID, @fecha_alta, @cantidad, @envio)
	SELECT @compraID = SCOPE_IDENTITY()
	INSERT INTO GDD_15.FACTURAS(N_ID_PUBLICACION, F_ALTA) VALUES (@publiID,@fecha_alta)
	SELECT @facturaID = SCOPE_IDENTITY()
	INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, N_ID_COMPRA, N_MONTO) VALUES (@facturaID, @compraID, @precioPubli * @cantidad * @porcentajeVisi)
	UPDATE GDD_15.PUBLICACIONES SET N_STOCK = (@stock - @cantidad) WHERE N_ID_PUBLICACION = @publiID
	IF  (@envio = 'SI')
	BEGIN
		SELECT @facturaID = SCOPE_IDENTITY()
		INSERT INTO GDD_15.FACTURAS_ITEMS(N_ID_FACTURA, N_ID_COMPRA, N_MONTO) VALUES (@facturaID, @compraID, @envioVisi)
	END
END;
GO
--INICIO MIGRACION --
EXEC GDD_15.MIGRO_DIRECCIONES;
EXEC GDD_15.MIGRO_USUARIOS;
EXEC GDD_15.MIGRO_RUBROS;
EXEC GDD_15.CARGO_ESTADO_TIPO_VISI;
EXEC GDD_15.MIGRO_PUBLICACIONES;
EXEC GDD_15.MIGRO_COMPRAS;
EXEC GDD_15.MIGRO_OFERTAS;
EXEC GDD_15.MIGRO_FACTURAS --MIGRA FACTURAS Y NO ITEMS TODAVIA 
;--EXEC GDD_15.MIGRO_CALIFICACIONES;--FALTA TERMINARLO 

-- FIN MIGRACION --















